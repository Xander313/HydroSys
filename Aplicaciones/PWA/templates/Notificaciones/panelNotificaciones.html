

{% extends 'layouts/baseSesionIniciada.html' %}
{% load static %}

{% block title %}Mis Notificaciones{% endblock %}

{% block seccion %}Mis Notificaciones{% endblock %}


{% block linksCss %}
{% endblock %}


{% block content %}


<div class="sensor-selector" style="margin-bottom: 20px;">
    <h3>üì° Selecciona un sensor:</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        {% for sensor in sensores %}
            <button 
                onclick="seleccionarSensor('{{ sensor.id }}')" 
                style="padding: 10px 20px; border: none; background-color: #3498db; color: white; border-radius: 8px; cursor: pointer;">
                Sensor {{ sensor.sensor.nombreSensor }} - {{ sensor.ubicacionSensor }}
            </button>
        {% endfor %}
    </div>
</div>

<div id="notificaciones-contenedor">
    <p>üîî Aqu√≠ se mostrar√°n las notificaciones del sensor seleccionado.</p>
</div>

<!-- Bot√≥n para activar sonido -->
<button id="activarSonidoBtn" style="display: none;">üîî Activar Sonidos</button>


<audio id="audioNotificacion" src="{% static 'pwa/sounds/notification.mp3' %}" preload="auto"></audio>

<script>
    document.getElementById('activarSonidoBtn').addEventListener('click', () => {
        const audio = document.getElementById("audioNotificacion");
        audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
            alert("Sonido activado correctamente.");
            document.getElementById('activarSonidoBtn').style.display = 'none';
        }).catch(err => {
            console.error("Error al activar sonido:", err);
            alert("Error al activar sonido.");
        });
    });
</script>


<script>
    let sonidoHabilitado = false;
    let ultimoIdNotificacion = null;

    document.getElementById('activarSonidoBtn').addEventListener('click', () => {
        const audio = document.getElementById("audioNotificacion");
        audio.play().then(() => {
            sonidoHabilitado = true;
            audio.pause();
            audio.currentTime = 0;
            alert("üîî Sonidos activados. Las nuevas notificaciones ahora emitir√°n un tono.");
            document.getElementById('activarSonidoBtn').style.display = 'none';
        }).catch(err => {
            console.error("No se pudo activar el audio:", err);
            alert("‚ùå No se pudo activar el sonido. Intenta nuevamente.");
        });
    });

    const urlNotificacionesBase = "{% url 'obtener_notificaciones_sensor' 0 %}";
    let sensorSeleccionado = null;
    let intervalo = null;

    function seleccionarSensor(sensorId) {
        sensorSeleccionado = sensorId;
        mostrarNotificaciones(sensorId);

        if (intervalo) clearInterval(intervalo);
        intervalo = setInterval(() => {
            if (sensorSeleccionado) {
                mostrarNotificaciones(sensorSeleccionado);
            }
        }, 60000); // cada 60 segundos
    }

    function mostrarNotificaciones(sensorId) {
        const url = urlNotificacionesBase.replace('0', sensorId);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const contenedor = document.getElementById("notificaciones-contenedor");
                contenedor.innerHTML = ""; // Limpia anteriores

                if (data.notificaciones.length === 0) {
                    contenedor.innerHTML = "<p>No hay notificaciones para este sensor.</p>";
                    return;
                }

                // üîä Reproducir sonido SIEMPRE que haya al menos una notificaci√≥n
                const audio = document.getElementById("audioNotificacion");
                audio.pause(); // Reinicia por si acaso
                audio.currentTime = 0;
                audio.play().catch(e => console.warn("No se pudo reproducir sonido:", e));

                const lista = document.createElement("ul");
                lista.style.listStyle = "none";
                lista.style.padding = "0";

                data.notificaciones.forEach(noti => {
                    const item = document.createElement("li");
                    item.style.marginBottom = "10px";
                    let color = "gray";

                    if (noti.tipo === "Alerta Azul") color = "#3498db";
                    else if (noti.tipo === "Alerta Naranja") color = "#e67e22";
                    else if (noti.tipo === "Alerta Roja") color = "#e74c3c";

                    item.innerHTML = `
                        <div style="border-left: 5px solid ${color}; padding: 10px; background: #f4f4f4; border-radius: 5px;">
                            <strong>${noti.tipo}</strong><br>
                            ${noti.mensaje}<br>
                            <small>${noti.fechaEnvio}</small>
                        </div>
                    `;
                    lista.appendChild(item);
                });

                contenedor.appendChild(lista);
            })
            .catch(error => {
                console.error("‚ùå Error al obtener notificaciones:", error);
            });
    }
</script>



{% endblock %}
